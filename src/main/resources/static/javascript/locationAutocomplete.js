//This code was referenced from code that were generated by ChatGPT and ClaudeAI

document.addEventListener('DOMContentLoaded', function () {
    const addressInput = document.getElementById('location');
    const suburbInput = document.getElementById('suburb');
    const cityInput = document.getElementById('city');
    const countryInput = document.getElementById('country');
    const postcodeInput = document.getElementById('postcode');
    const autocompleteResults = document.getElementById('autocomplete-results');
    const xmlRequest = new XMLHttpRequest();

    addressInput.addEventListener('input', function () {
        const inputValue = this.value.trim();
        if (inputValue.length > 0) {
            if (isValidInput(inputValue)) {
                fetchAutocomplete(inputValue)
                    .then(data => {
                        showAutocompleteResults(data);
                    })
                    .catch(err => {
                        console.error(err);
                    });
            }
        } else {
            hideAutocompleteResults();
        }
    });

    function fetchAutocomplete(query) {
        return new Promise((resolve, reject) => {
            xmlRequest.open('GET', '../sendRequest?query=' + encodeURIComponent(query));
            xmlRequest.onload = function () {
                if (xmlRequest.status === 200) {
                    const responseData = JSON.parse(xmlRequest.responseText);
                    console.log('Response from Java:', responseData);
                    resolve(responseData);
                    return responseData.json();
                } else {
                    console.error('Error:', xmlRequest.statusText);
                    reject(new Error('Network response was not ok'));
                }
            };
            xmlRequest.onerror = function () {
                reject(new Error('Request failed'));
            };
            xmlRequest.send();
        });
    }

    function showAutocompleteResults(results) {
        autocompleteResults.innerText = '';
        if (results.error) {
            const item = document.createElement('div');
            item.classList.add('autocomplete-item');
            item.textContent = "No matching location found, location-based services may not work"
            item.style.color = 'red';
            autocompleteResults.appendChild(item);
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.classList.add('autocomplete-item');
                item.classList.add('text-dark');
                const address = result.address;
                const displayParts = [
                    address.house_number + " " + address.road,
                    address.suburb,
                    address.city,
                    address.postcode,
                    address.country
                ].filter(Boolean);

                item.textContent = displayParts.join(', ');

                item.addEventListener('mouseover', function() {
                    this.style.backgroundColor = '#f0f0f0';
                });
                item.addEventListener('mouseout', function() {
                    this.style.backgroundColor = '';
                });
                item.addEventListener('click', function () {
                    fillAddressDetails(result);
                    hideAutocompleteResults();
                });
                autocompleteResults.appendChild(item);
            });
        }
        autocompleteResults.classList.add('visible');
    }

    function hideAutocompleteResults() {
        autocompleteResults.innerText = '';
        autocompleteResults.classList.remove('visible');
    }

    function fillAddressDetails(address) {
        const addressInputValue = `${address.address.house_number || ''} ${address.address.road || ''}`;
        addressInput.value = addressInputValue.trim();
        suburbInput.value = address.address.suburb || '';
        cityInput.value = `${address.address.city || ''}`;
        countryInput.value = address.address.country || '';
        postcodeInput.value = address.address.postcode || '';
    }

    document.addEventListener('click', function (event) {
        const target = event.target;
        if (!target.closest('.autocomplete-container')) {
            hideAutocompleteResults();
        }
    });


    //This is added to accept only all the language and numeric characters plus some relevant special characters for addresses.
    function isValidInput(input) {
        return /^[\p{L}\p{N}\s\-',./()]+$/u.test(input);
    }
});