<!DOCTYPE html>
<html lang="en">
<head th:insert="~{fragmentExample/fragments/bootstrap.html}">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>User Profile</title>
    <link rel="stylesheet" th:href="@{/css/stylesheet.css}">
</head>
<body>

<div th:insert="~{fragmentExample/fragments/navbar.html}"></div>

<div id="user_div">
    <h1>User Profile</h1>
    <div class="UserProfilePicContainer">
        <form th:action="@{user}" method="post" enctype="multipart/form-data" id="uploadImageForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <img th:src="@{${profilePic}}" alt="Profile Picture" id="currentProfilePic">
            <button type="button" class="image-button" id="fileInputBtn" onclick="handleImageClick()">+</button>
            <input type="file" id="fileInput" name="file" style="display: none;" accept="image/*"
                   onchange="handleImageChange()">
        </form>
    </div>
    <div class="warningMessageContainer">
        <p th:text="${uploadMessage}" th:value="*{uploadMessage}" class="errorMessage"></p>
    </div>

    <div id="form">
        <form th:action="@{user}" method="get" id="userForm" novalidate>
            <label for="firstName"> First Name: </label>
            <span id="firstName" th:text="${firstName}"></span>
            <input autofocus class="form-control" data-cy="firstName" id="firstNameEdit" maxlength="255"
                   placeholder="First Name" required th:name="firstName" th:value="*{firstName}" type="text"
                   style="display: none;"
                   th:classappend="${firstNameValid != '' ? 'error' : ''}">
            <p class="smallErrorMessage" th:utext="${firstNameValid}"></p>
            <br/>

            <label for="lastName"> Last Name: </label>
            <span id="lastName" th:text="${lastName}"></span>
            <input class="form-control" data-cy="lastName" id="lastNameEdit" placeholder="Last Name" maxlength="255"
                   th:name="lastName" th:value="*{lastName}" type="text" style="display: none"
                   th:classappend="${lastNameValid != '' ? 'error' : ''}">
            <br/>
            <div id="surnameCheck">
                <label id="isLastNameOptionalLabelEdit" style="display: none;">I have no surname:</label>
                <input class="form-control" data-cy="isLastNameOptional" id="isLastNameOptional" name="isLastNameOptional"
                       placeholder="Last Name Tick Box Check"
                       th:name="isLastNameOptional" type="checkbox" style="display: none;">
            </div>
            <script>
                document.getElementById('isLastNameOptional').checked = false;
                document.getElementById('isLastNameOptional').onchange = function () {
                    document.getElementById('lastNameEdit').disabled = this.checked;
                };
            </script>
            <p class="smallErrorMessage" th:utext="${lastNameValid}"></p>
            <br/>

            <label for="DoB"> Date of Birth: </label>
            <span id="DoB" th:text="${DoB}"></span>
            <input class="form-control" id="DoBEdit" th:name="DoB" th:value="*{DoB}" type="date" style="display: none;" th:classappend="${(DoBValid != '' && DoBValid != null) ? 'error' : ''}">
            <p class="smallErrorMessage" id="DoBInvalid" th:utext="${DoBValid}"></p>
            <input type="hidden" id="isDoBInvalid" th:name="isDoBInvalid" th:value="false"/>
            <br/>
            <label for="email"> Email: </label>
            <span id="email" th:text="${email}"></span>
            <input class="form-control" data-cy="email" id="emailEdit" placeholder="Email" maxlength="320"
                   th:name="email" th:value="*{email}" type="text" style="display: none;"
                   th:classappend="${emailValid != '' ? 'error' : ''}">
            <p class="smallErrorMessage" th:utext="${emailValid}"></p>
            <br/>

            <div id="editButtonDiv">
                <button class="buttonDesign" type="button" onclick="enableEditing()">Edit</button>
            </div>
            <div id="saveCancelButtonDiv" style="display: none;">
                <button type="button" onclick="window.location='./password'">Update password</button>
                <input type="submit" value="Save"/>
                <button type="button" onclick="disableEditing(); window.location='./user'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
    document.getElementById("userForm").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            var activeElement = document.activeElement;
            if (activeElement.id === "emailEdit" || activeElement.type === "submit" || activeElement.tagName === "BUTTON") {
                return true;
            } else {
                event.preventDefault();
            }
        }
    });
</script>
<script>
    document.getElementById("userForm").addEventListener("submit", function(event) {
        const dobInput = document.getElementById("DoBEdit");
        if (!(dobInput.checkValidity())) {
            console.log("invalid date")
            event.preventDefault();
            document.getElementById("isDoBInvalid").value = true;
            document.getElementById("userForm").submit();
        } else {
            console.log("valid date")
            document.getElementById("isDoBInvalid").value = false;
        }
    });
    function handleImageClick() {
        document.getElementById('fileInput').click();
    }

    function handleImageChange() {
        document.getElementById('uploadImageForm').submit();
    }

    function enableEditing() {
        document.getElementById('editButtonDiv').style.display = 'none';
        document.getElementById('saveCancelButtonDiv').style.display = 'block';

        document.getElementById('firstName').style.display = 'none';
        document.getElementById('firstNameEdit').style.display = 'inline';

        document.getElementById('lastName').style.display = 'none';
        document.getElementById('lastNameEdit').style.display = 'inline';
        document.getElementById('isLastNameOptional').style.display = 'inline';
        document.getElementById('isLastNameOptionalLabelEdit').style.display = 'inline';
        let lName = document.getElementById('lastNameEdit');
        if (lName.value.trim() === "") {
            document.getElementById('isLastNameOptional').checked = true;
            document.getElementById('lastNameEdit').disabled = true;
        }

        document.getElementById('DoB').style.display = 'none';
        document.getElementById('DoBEdit').style.display = 'inline';

        document.getElementById('email').style.display = 'none';
        document.getElementById('emailEdit').style.display = 'inline';

    }

    function disableEditing() {
        document.getElementById('editButtonDiv').style.display = 'block';
        document.getElementById('saveCancelButtonDiv').style.display = 'none';

        document.getElementById('firstName').style.display = 'inline';
        document.getElementById('firstNameEdit').style.display = 'none';

        document.getElementById('lastName').style.display = 'inline';
        document.getElementById('lastNameEdit').style.display = 'none';
        document.getElementById('isLastNameOptional').style.display = 'none';
        document.getElementById('isLastNameOptionalLabelEdit').style.display = 'none';

        document.getElementById('DoB').style.display = 'inline';
        document.getElementById('DoBEdit').style.display = 'none';

        document.getElementById('email').style.display = 'inline';
        document.getElementById('emailEdit').style.display = 'none';

        window.location.href = '/user'
    }
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var firstNameValid = /*[[${firstNameValid}]]*/ '';
    var lastNameValid = /*[[${lastNameValid}]]*/ '';
    var DoBValid = /*[[${DoBValid}]]*/ '';
    var emailValid = /*[[${emailValid}]]*/ '';
    var uploadMessage = /*[[${uploadMessage}]]*/ '';

    if ((firstNameValid !== '' || lastNameValid !== '' || DoBValid !== '' || emailValid !== '')) {
        console.log("edit");
        enableEditing();
    }
    /*]]>*/
</script>
</body>
</html>