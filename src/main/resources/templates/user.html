<!DOCTYPE html>
<html lang="en">
<head th:insert="~{fragmentExample/fragments/bootstrap.html}">
    <title>User Profile</title>
</head>

<body>

<div th:insert="~{fragmentExample/fragments/navbar.html}"></div>

<button class="btn btn-success w-auto m-2" data-bs-target="#exampleModal" data-bs-toggle="modal" type="button">
    Edit Homepage
</button>

<div class="mb-5" id="user_div">
    <h1 class="text-dark">User Profile</h1>
    <div class="UserProfilePicContainer">
        <form th:action="@{user}" method="post" enctype="multipart/form-data" id="uploadImageForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <img th:src="@{${profilePic}}" alt="Profile Picture" id="currentProfilePic">
            <button type="button" class="image-button" id="fileInputBtn" onclick="handleImageClick()">+</button>
            <input type="file" id="fileInput" name="file" style="display: none;" accept="image/*"
                   onchange="handleImageChange()">
        </form>
    </div>

    <div class="warningMessageContainer">
        <p th:text="${uploadMessage}" th:value="*{uploadMessage}" class="errorMessage"></p>
    </div>

    <div class="container card w-50">
        <form th:action="@{user}" method="get" id="userForm">

            <label for="firstName"> First Name: </label>
            <span id="firstName" th:text="${firstName}"></span>
            <input autofocus class="form-control" data-cy="firstName" id="firstNameEdit" maxlength="255"
                   placeholder="First Name" th:name="firstName" th:value="*{firstName}" type="text"
                   style="display: none;"
                   th:classappend="${firstNameValid != '' ? 'is-invalid' : ''}">
            <p class="smallErrorMessage" th:utext="${firstNameValid}"></p>
            <br/>

            <label for="lastName"> Last Name: </label>
            <span id="lastName" th:text="${lastName}"></span>
            <input class="form-control" data-cy="lastName" id="lastNameEdit" placeholder="Last Name" maxlength="255"
                   th:name="lastName" th:value="*{lastName}" type="text" style="display: none"
                   th:classappend="${lastNameValid != '' ? 'is-invalid' : ''}"
                   th:disabled="${isLastNameOptional}">
            <br/>

            <div id="surnameCheck" class="m-3">
                <label id="isLastNameOptionalLabelEdit" for="isLastNameOptional" style="display: none;">I have no surname:</label>
                <input class="form-check-input" data-cy="isLastNameOptional" id="isLastNameOptional" name="isLastNameOptional"
                       placeholder="Last Name Tick Box Check" th:checked="${isLastNameOptional}"
                       th:name="isLastNameOptional" type="checkbox" style="display: none;">
            </div>

            <script>
                document.getElementById('isLastNameOptional').onchange = function () {
                    document.getElementById('lastNameEdit').disabled = this.checked;
                };
            </script>

            <p class="smallErrorMessage" th:utext="${lastNameValid}" id="lastNameError"></p>
            <br/>

            <label for="DoB"> Date of Birth: </label>
            <span id="DoB" th:text="${DoB}"></span>
            <input class="form-control" id="DoBEdit" th:name="DoB" th:value="*{DoB}" type="date" style="display: none;"
                   th:classappend="${(DoBValid != '' && DoBValid != null) ? 'is-invalid' : ''}" max="9999-12-31">
            <p class="smallErrorMessage" id="DoBInvalid" th:utext="${DoBValid}"></p>

            <script>
                document.getElementById("DoBEdit").addEventListener("invalid",
                    function (event) {
                        event.preventDefault();
                        console.log("invalid date");
                        document.getElementById("DoBEdit").style.border = "1px solid red";
                        document.getElementById("DoBInvalid").textContent = "Date is not in valid format, DD/MM/YYYY";
                    });
            </script>

            <br/>
            <label for="email"> Email: </label>
            <span id="email" th:text="${email}"></span>
            <input class="form-control" data-cy="email" id="emailEdit" placeholder="Email" maxlength="320"
                   th:name="email" th:value="*{email}" type="text" style="display: none;"
                   th:classappend="${emailValid != '' ? 'is-invalid' : ''}">
            <p class="smallErrorMessage" th:utext="${emailValid}"></p>
            <br/>

            <div id="editButtonDiv">
                <button class="btn btn-primary mb-3" type="button" onclick="enableEditing()">Edit</button>
            </div>
            <div id="saveCancelButtonDiv" class="m-0 p-0 d-flex gap-5" style="display: none !important;">
                <button class="btn btn-secondary mb-3" type="button" onclick="window.location='./password'">Update password</button>
                <input class="btn btn-primary mb-3" type="submit" value="Save"/>
                <button class="btn btn-danger mb-3" type="button" onclick="disableEditing(); window.location='./user'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal -->
<div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" id="exampleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title text-dark" id="exampleModalLabel">Edit Layout</h1>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body d-grid">
                <form id='layoutForm' method="post" th:action="@{changeLayout}">
                    <input type="hidden" value="1" id="layout" th:name="layout">
                    <div class="row mb-3">
                        <div class="col">
                            <button class="selectable" onclick="selectOption(this, 1)" type="button">
                                <img alt="layout1" th:src="@{/images/layout1.png}">
                            </button>
                        </div>
                        <div class="col">
                            <button class="selectable" onclick="selectOption(this, 2)" type="button">
                                <img alt="layout2" th:src="@{/images/layout2.png}">
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <button class="selectable" onclick="selectOption(this, 3)" type="button">
                                <img alt="layout3" th:src="@{/images/layout3.png}">
                            </button>
                        </div>
                        <div class="col">
                            <button class="selectable" onclick="selectOption(this, 4)" type="button">
                                <img alt="layout4" th:src="@{/images/layout4.png}">
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer d-flex justify-content-around">
                <button class="btn btn-primary" onclick="document.getElementById('layoutForm').submit()" type="submit">
                    Save changes
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    document.getElementById("userForm").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            var activeElement = document.activeElement;
            if (activeElement.id === "emailEdit" || activeElement.type === "submit" || activeElement.tagName === "BUTTON") {
                return true;
            } else {
                event.preventDefault();
            }
        }
    });
</script>
<script>
    document.getElementById("userForm").addEventListener("submit", function(event) {
        const dobInput = document.getElementById("DoBEdit");
        if (!(dobInput.checkValidity())) {
            console.log("invalid date")
            event.preventDefault();
            document.getElementById("isDoBInvalid").value = true;
            document.getElementById("userForm").submit();
        } else {
            console.log("valid date")
            document.getElementById("isDoBInvalid").value = false;
        }
    });
    function handleImageClick() {
        document.getElementById('fileInput').click();
    }

    function handleImageChange() {
        document.getElementById('uploadImageForm').submit();
    }

    function enableEditing() {
        document.getElementById('editButtonDiv').style.display = 'none';
        document.getElementById('saveCancelButtonDiv').style.display = 'block';

        document.getElementById('firstName').style.display = 'none';
        document.getElementById('firstNameEdit').style.display = 'inline';

        document.getElementById('lastName').style.display = 'none';
        document.getElementById('lastNameEdit').style.display = 'inline';
        document.getElementById('isLastNameOptional').style.display = 'inline';
        document.getElementById('isLastNameOptionalLabelEdit').style.display = 'inline';
        let lName = document.getElementById('lastNameEdit');
        let lNameError = document.getElementById("lastNameError")
        if (lName.value.trim() === "" && lNameError.textContent === "") {
            document.getElementById('isLastNameOptional').checked = true;
            document.getElementById('lastNameEdit').disabled = true;
        }

        document.getElementById('DoB').style.display = 'none';
        document.getElementById('DoBEdit').style.display = 'inline';

        document.getElementById('email').style.display = 'none';
        document.getElementById('emailEdit').style.display = 'inline';

    }

    function disableEditing() {
        document.getElementById('editButtonDiv').style.display = 'block';
        document.getElementById('saveCancelButtonDiv').style.display = 'none';

        document.getElementById('firstName').style.display = 'inline';
        document.getElementById('firstNameEdit').style.display = 'none';

        document.getElementById('lastName').style.display = 'inline';
        document.getElementById('lastNameEdit').style.display = 'none';
        document.getElementById('isLastNameOptional').style.display = 'none';
        document.getElementById('isLastNameOptionalLabelEdit').style.display = 'none';

        document.getElementById('DoB').style.display = 'inline';
        document.getElementById('DoBEdit').style.display = 'none';

        document.getElementById('email').style.display = 'inline';
        document.getElementById('emailEdit').style.display = 'none';

        window.location.href = '/user'
    }
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var firstNameValid = /*[[${firstNameValid}]]*/ '';
    var lastNameValid = /*[[${lastNameValid}]]*/ '';
    var DoBValid = /*[[${DoBValid}]]*/ '';
    var emailValid = /*[[${emailValid}]]*/ '';
    var uploadMessage = /*[[${uploadMessage}]]*/ '';

    if ((firstNameValid !== '' || lastNameValid !== '' || DoBValid !== '' || emailValid !== '')) {
        console.log("edit");
        enableEditing();
    }

    // The following function was generated by chatGPT
    function selectOption(button, optionNumber) {
        // Remove the 'selected' class from all buttons
        const buttons = document.querySelectorAll('.selectable');
        buttons.forEach(btn => btn.classList.remove('selected'));

        // Add the 'selected' class to the clicked button
        button.classList.add('selected');

        document.getElementById('layout').value = optionNumber;
    }
    /*]]>*/
</script>
</body>
</html>