<!DOCTYPE html>
<html lang="en-uk">
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <title>Garden Details</title>
    <link rel="stylesheet" th:href="@{/css/stylesheet.css}">
</head>
<body>

<div th:insert="~{fragmentExample/fragments/bootstrap.html}"></div>
<nav th:insert="~{fragmentExample/fragments/navbar.html}"></nav>

<div class="container">
    <!-- Top half -->
    <div class="row">
        <!-- Back to Gardens and  Edit garden in this row-->
        <div class="row">
            <div class="col-sm">
                <a th:href="@{../gardens}" class="btn btn-success back-to-my-gardens-button">Back to My Gardens</a> <!-- shares CSS -->
            </div>
            <div class="col-sm text-end">
                <a th:href="@{../gardens/edit(gardenId=${garden.id})}" class="btn btn-success edit-garden-button">Edit Garden</a>
            </div>
        </div>
        <div class="d-flex gap-5">
            <!-- Garden Details, including tags and public checkbox -->
            <div class="container">
                <div class="card">
                    <h1 class="text-center">Garden Details</h1>
                    <p><strong>Name:</strong> <span th:text="${garden.name}"></span></p>
                    <p><strong>Location:</strong> <span th:text="${garden.getFullLocation()}"></span></p>
                    <p><strong>Size:</strong> <span th:if="${garden.size != null}" th:text="${garden.size + ' m^2'}"></span></p>
                    <p><strong>Description:</strong> <span th:text="${garden.description}"></span></p>

                    <div class="row" id="tag-container">
                        <strong>Tags:</strong>
                        <div th:if="${tags != null}" th:each="tag : ${tags}" id="tag">
                            <span th:text="${tag}"></span>
                        </div>
                        <a id="add-tag" th:style="${tag != null} ? 'display: none;' : 'display: block;'"
                           onclick="transformToInput()" class="btn btn-success">+</a>

                        <form id="hidden-tag-form" method="post" autocomplete="off" th:action="@{addTag}">
                            <input type="text" id="tag-input" list="tagList" autocomplete="off" th:value="${tag != null ? tag : ''}"
                                   th:style="${tag != null} ? 'display: block;' : 'display: none;'" placeholder="Add tag..."
                                   maxlength="25" onkeydown="submitTagOnEnter(event)" autofocus
                                   th:classappend="${(tagValid != '' && tagValid != null) ? 'error' : ''}">
                            <input type="hidden" name="tag-input" id="hidden-tag-input">
                            <input type="hidden" name="gardenId" th:value="${garden.id}">
                            <datalist id="tagList">
                                <option th:each="tag : ${allTags}" th:value="${tag}" th:text="${tag}"></option>
                            </datalist>
                        </form>

                        <a id="submit-tag" th:style="${tag != null} ? 'display: block;' : 'display: none;'"
                           onclick="submitTag()" class="btn btn-success">+</a>
                    </div>

                    <div id="tag-error-container" class="container">
                        <p id="tag-error-message" th:value="${tagValid}" th:utext="${tagValid}"></p>
                    </div>
                    <div class="container">
                        <form method="post" th:action="@{../gardens/details(gardenId=${garden.id})}" id="garden-details-form">
                            <div class="row">
                                <div class="col-sm">
                                    <label for="isGardenPublic" id="public-checkbox-label">Make my garden public</label>
                                    <input data-cy="isGardenPublic" id="isGardenPublic" name="isGardenPublic"
                                           th:id="isGardenPublic" th:name="isGardenPublic" type="checkbox"
                                           onchange="document.getElementById('garden-details-form').submit()"/>
                                </div>
                            </div>

                            <script th:inline="javascript">
                                // Credit: https://stackoverflow.com/questions/31771821/thymeleaf-how-to-add-conditional-block-in-javascript
                                let isGardenPublic = [[${garden.isGardenPublic}]];
                                document.getElementById("isGardenPublic").checked = isGardenPublic;
                            </script>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Weather Carousel -->
            <div class="w-50 overflow-scroll">
                <div id="location-error" th:if="${date == null}">Location not found, please update your location to see the weather
                </div>
                <ul class="list-group list-group-horizontal">
                    <li class="weather-display-container" th:if="${date}">
                        <div class="card">
                            <img class="card-img-top" alt="No image available" th:src="'https:' + ${weatherImage}"/>
                            <div class="card-body">
                                <div class="weather-display-row">
                                    <h3 th:text="${garden.city + ', ' + garden.country}"></h3>
                                    <h4 id="currentDate"></h4>
                                    <p th:text="${date}"></p>
                                    <div class="temperature-container">
                                        <div class="weather-display-row">
                                            <div class="temperature-container">
                                                <h3 class="temperature" th:text="${temperature}"></h3>
                                                <span><sup style="font-weight: bold">&deg;C</sup></span>
                                            </div>
                                            <br>
                                            <p th:text="${weatherDescription}"></p>
                                            <p th:text="${humidity} + '%' + ' Humidity'"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!--                        <div style="text-align: center;"><h2>Next 3 days:</h2></div>-->
                    <li class="future-weather weather-display-container" th:each="forecastMinTemp, iter: ${forecastMinTemperature}">
                        <div class="card">
                            <img class="card-img-top" alt="No image available" th:src="'https:' + ${forecastWeatherImage.get(iter.index)}"/>
                            <div class="card-body">
                                <div class="weather-display-row">
                                    <p th:text="${forecastDates.get(iter.index)}"></p>
                                    <h4 th:id="${(iter.index)}" onload=getDay()></h4>
                                    <div class="temperature-container">
                                        <div class="weather-display-row">
                                            <div class="temperature-container">
                                                <h5>Low</h5>
                                                <h4 class="temperature" th:text="${forecastMinTemp}"></h4>
                                                <span><sup style="font-weight: bold">&deg;C</sup></span>
                                            </div>
                                            <div class="temperature-container">
                                                <h5>High</h5>
                                                <h4 class="temperature" th:text="${forecastMaxTemperature.get(iter.index)}"></h4>
                                                <span><sup style="font-weight: bold">&deg;C</sup></span>
                                            </div>
                                            <br>
                                            <p th:text="${forecastWeatherDescription.get(iter.index)}"></p>
                                            <p th:text="${forecastHumidities.get(iter.index)} + '%' + ' Humidity'"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Bottom half -->
    <div class="row">
        <!-- Header row - Plant title and Add Plant button -->
        <div class="row">
            <div class="col-sm">
                <h4>Plants:</h4>
            </div>
            <div class="col-sm">
                <h1 class="container">
                    <a th:href="@{../gardens/details/plants/form(gardenId=${garden.id})}" class="btn btn-success">
                        Add New Plant</a>
                </h1>
            </div>
        </div>
        <!-- Plants row, table of plant cards -->
        <div class="container">
            <div class="card" th:each="plant, iter : ${garden.plants}">
                <form class="plant-image-container" enctype="multipart/form-data"
                      method="post" th:action="@{../gardens/details/plants/image}"
                      th:id="'uploadPlantForm_' + ${plant.id}">
                    <input th:name="plantId" th:value="${plant.id}" type="hidden"/>
                    <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>
                    <img class="card-img-top" alt="Plant"
                         th:id="'currentImage_' + ${plant.id}" th:src="@{${plant.image}}">
                    <button class="image-button" th:onclick="'handleImageClick(\'' + ${plant.id} + '\');'"
                            type="button">+
                    </button>
                    <input accept="image/*" name="file" style="display: none;"
                           th:id="'fileInput_' + ${plant.id}"
                           th:onchange="'handleImageChange(\'' + ${plant.id} + '\');'" type="file">
                </form>
                <div class="card-body">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm">
                                <h6 th:text="${plant.name}"></h6>
                            </div>
                            <div class="col-sm">
                                <h6 th:if="${plant.count !=0}" th:text="${plant.count}"></h6>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm">
                                <p th:text="${plant.description}"></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm">
                                <form method="get" th:action="@{../gardens/details/plants/edit}">
                                    <input th:name="plantId" th:value="${plant.id}" type="hidden"/>
                                    <button class="button" type="submit">Edit</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <span class="errorMessage" th:if="${uploadError} and ${plant.id} == ${errorId}"
                      th:text="${uploadError}"></span>
                </div>
            </div>
        </div>
    </div>
    <!-- Watering notification pop up -->
    <div id="notification" class="notification" th:if="${wateringTip}">
        <p th:text="${wateringTip}"></p>
        <form id="lastNotifiedForm" method="post" th:action="@{../gardens/details/dismissNotification}">
            <input th:name="gardenId" th:value="${garden.id}" type="hidden">
            <button type="submit" onclick="closeNotification()" class="close-button">x</button>
        </form>
    </div>

</div>

<script>
    window.onload = function () {
        const weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        const d = new Date();
        const day = weekday[d.getDay()];
        document.getElementById("currentDate").innerText = day;
        for(let i = 0; i <= 2 ; i++) {
            let d = new Date();
            d.setDate(d.getDate() + i);
            const day = weekday[d.getDay()];
            document.getElementById(i.toString()).innerText = day;
        }
    }

    function getCurrentDay() {
        const weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        // const day = weekday[date.getDay()];

    }

    function getDay(date) {
        const weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        const day = weekday[date.getDay()];
        document.getElementById(date).innerText = day;

    }
    function handleImageClick(plantId) {
        document.getElementById('fileInput_' + plantId).click();
    }

    function handleImageChange(plantId) {
        document.getElementById('uploadPlantForm_' + plantId).submit();
    }

    // got from stack overflow: https://stackoverflow.com/questions/30022728/perform-action-when-clicking-html5-datalist-option
    // it is used to check if the user clicked an option from the autocomplete and if so to submit the form
    const tagInput = document.getElementById('tag-input');
    const tagForm = document.getElementById("hidden-tag-form");
    const dataList = document.getElementById("tagList");
    let removedOption = "";
    let keypress = false;
    tagInput.addEventListener("keydown", (e) => {
        if(e.key) {
            keypress = true;
        }
    });
    tagForm.addEventListener('input', (e) => {
        const inputValue = tagInput.value;
        const options = dataList.options
        if (keypress === false) {
            document.getElementById('hidden-tag-input').value = inputValue;
            tagForm.submit();
        }
        if(inputValue !== removedOption && removedOption !== "") {
            let newOption = document.createElement("option");
            newOption.value = removedOption;
            newOption.text = removedOption;
            dataList.appendChild(newOption);
            removedOption = "";
        }
        for (let i = 0; i < options.length; i++) {
            if (options[i].value === inputValue) {
                removedOption = options[i].value;
                options[i].remove();
                break;
            }
        }

        keypress = false;
    });

    // const currentDate = new Date();
    // const dateOptions = {
    //     weekday: 'long',
    //     day: 'numeric',
    //     month: 'long',
    //     year: 'numeric'
    // };
    // document.getElementById("currentDateDisplay").innerText = currentDate.toLocaleString("en-Nz", dateOptions);

    function transformToInput() {
        document.getElementById('add-tag').style.display = 'none';
        document.getElementById('tag-input').style.display = 'block';
        document.getElementById('submit-tag').style.display = 'block';
        document.getElementById('tag-input').focus();
    }

    function submitTagOnEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const tagInput = document.getElementById('tag-input').value.trim();
            if (tagInput) {
                console.log('Submitting tag:', tagInput);
                // Set the hidden form inputs
                document.getElementById('hidden-tag-input').value = tagInput;
                document.getElementById('hidden-tag-form').submit();
            } else {
                console.log('No tag input to submit');
            }
        }
    }

    function submitTag() {
        const tagInput = document.getElementById('tag-input').value.trim();
        if (tagInput) {
            console.log('Submitting tag:', tagInput);
            // Set the hidden form inputs
            document.getElementById('hidden-tag-input').value = tagInput;
            document.getElementById('hidden-tag-form').submit();
        } else {
            console.log('No tag input to submit');
        }
    }

    function closeNotification() {
        document.getElementById('notification').style.display = 'none';
    }

</script>

</body>
</html>

